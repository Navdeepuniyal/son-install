---
- name: deployment of SP GATEKEEPER as a Docker containers from Registry
  hosts: "{{ target }}"
  sudo: yes
  tasks:

  # Running the Sonata GK VIM Docker Image
  - name: GATEKEEPER VIM - running Docker containers
    docker_container:
      name: son-gtkvim
      image: sonatanfv/son-gtkvim
      env:
        RACK_ENV: integration
        MQSERVER: amqp://guest:guest@{{ public_ip }}:5672
        DATABASE_HOST: "{{ public_ip }}"
        DATABASE_PORT: 5432
        POSTGRES_PASSWORD: sonata
        POSTGRES_USER: sonatatest
      links:
        - son-broker
      state: started
      ports: "5700:5700"
      command: sh -c -e "bundle exec rake db:migrate"
      detach: false

  - name: wait for Container to finish
    shell: >
      docker wait son-gtkvim

